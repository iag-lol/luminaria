<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspección de Luminarias del Terminal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (para el mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map { 
            height: 400px; 
            width: 100%;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- MENSAJE DE CONFIGURACIÓN REQUERIDA -->
    <div id="config-warning" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4 rounded-md" role="alert">
        <p class="font-bold">¡Acción Requerida!</p>
        <p>Debes configurar tus credenciales de Supabase en el archivo HTML para que la aplicación funcione. Edita el código y reemplaza los valores de `SUPABASE_URL` y `SUPABASE_ANON_KEY`.</p>
    </div>

    <div id="app-content" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Inspección de Luminarias</h1>
            <p class="text-gray-600 mt-2">Registra el estado de las luminarias del terminal.</p>
        </header>

        <main class="bg-white p-6 rounded-xl shadow-lg">
            <form id="inspectionForm" class="space-y-6">
                
                <div>
                    <label for="luminaireId" class="block text-sm font-medium text-gray-700">Identificador del Poste / Luminaria</label>
                    <input type="text" id="luminaireId" name="luminaireId" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="status" name="status" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="Bueno">Bueno</option>
                        <option value="Dañado">Dañado</option>
                        <option value="Mantenimiento">Requiere Mantenimiento</option>
                    </select>
                </div>

                <div id="imageUploadContainer" class="hidden">
                    <label for="imageFile" class="block text-sm font-medium text-gray-700">Subir Imagen (si está dañada)</label>
                    <input type="file" id="imageFile" name="imageFile" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Notas Adicionales</label>
                    <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ubicación del Daño</label>
                    <p class="text-xs text-gray-500 mb-2">Tu ubicación se actualiza en tiempo real. Si necesitas ajustar la posición final, arrastra el pin azul al lugar exacto.</p>
                    <div id="map"></div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                </div>

                <div class="text-right">
                    <button type="submit" id="submitButton" class="inline-flex justify-center items-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span id="buttonText">Enviar Reporte</span>
                        <div id="loader" class="loader hidden ml-3"></div>
                    </button>
                </div>
            </form>
        </main>
    </div>

    <!-- Modal para mensajes -->
    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modalIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full"></div>
                <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="modalMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalButton" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS (para el mapa) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        // --- CONFIGURACIÓN DE SUPABASE ---
        // IMPORTANTE: Reemplaza con los datos de tu proyecto Supabase.
        // Puedes encontrarlos en tu panel de Supabase > Project Settings > API.
        const SUPABASE_URL = 'https://tcmtxvuucjttngcazgff.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0';

        const configWarning = document.getElementById('config-warning');
        const appContent = document.getElementById('app-content');

        // --- VERIFICACIÓN INICIAL ---
        if (SUPABASE_URL.includes('TU_PROYECTO_URL') || SUPABASE_ANON_KEY.includes('TU_SUPABASE_ANON_KEY')) {
            configWarning.classList.remove('hidden');
            appContent.classList.add('hidden');
            // Detiene la ejecución si no está configurado
            throw new Error("Supabase no está configurado. Por favor, edita el script y añade tus credenciales.");
        }

        // --- INICIALIZACIÓN DE LA APP (SOLO SI LA CONFIGURACIÓN ES CORRECTA) ---
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- ELEMENTOS DEL DOM ---
        const form = document.getElementById('inspectionForm');
        const statusSelect = document.getElementById('status');
        const imageUploadContainer = document.getElementById('imageUploadContainer');
        const imageFileInput = document.getElementById('imageFile');
        const latInput = document.getElementById('latitude');
        const lonInput = document.getElementById('longitude');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loader = document.getElementById('loader');

        // --- LÓGICA DEL MAPA (LEAFLET) ---
        let map;
        let userMarker;
        let reportMarkers = {}; // Objeto para guardar los marcadores de reportes existentes
        let isMapInitialized = false;
        const defaultCoords = [-33.4489, -70.6693]; 

        function initializeMap(coords) {
            map = L.map('map').setView(coords, 18);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(map);

            userMarker = L.marker(coords, { draggable: true }).addTo(map);
            
            latInput.value = coords[0];
            lonInput.value = coords[1];

            userMarker.on('dragend', function(event) {
                const position = event.target.getLatLng();
                latInput.value = position.lat;
                lonInput.value = position.lng;
            });
            
            // Cargar y suscribirse a los reportes existentes
            subscribeToReports();
            isMapInitialized = true;
        }

        // --- LÓGICA DE GEOLOCALIZACIÓN (EN TIEMPO REAL) ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (position) => {
                    const userCoords = [position.coords.latitude, position.coords.longitude];
                    if (!isMapInitialized) {
                        initializeMap(userCoords);
                    } else {
                        const newLatLng = new L.LatLng(userCoords[0], userCoords[1]);
                        userMarker.setLatLng(newLatLng);
                        map.panTo(newLatLng);
                        latInput.value = userCoords[0];
                        lonInput.value = userCoords[1];
                    }
                },
                () => {
                    if (!isMapInitialized) {
                        initializeMap(defaultCoords);
                        showMessage('Geolocalización Falló', 'No se pudo obtener tu ubicación. Se usará una por defecto. Arrastra el pin al lugar correcto.', 'warning');
                    }
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            initializeMap(defaultCoords);
            showMessage('Geolocalización no Soportada', 'Tu navegador no soporta geolocalización. Arrastra el pin al lugar correcto.', 'warning');
        }

        // --- LÓGICA DEL FORMULARIO ---
        statusSelect.addEventListener('change', (e) => {
            imageUploadContainer.classList.toggle('hidden', e.target.value !== 'Dañado');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            const formData = new FormData(form);
            const dataToInsert = {
                luminaire_id: formData.get('luminaireId'),
                status: formData.get('status'),
                notes: formData.get('notes'),
                latitude: parseFloat(formData.get('latitude')),
                longitude: parseFloat(formData.get('longitude')),
                image_url: null
            };
            const imageFile = imageFileInput.files[0];
            
            try {
                if (dataToInsert.status === 'Dañado' && imageFile) {
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${dataToInsert.luminaire_id.replace(/\s+/g, '_')}-${Date.now()}.${fileExt}`;
                    
                    const { error: uploadError } = await dbClient.storage
                        .from('luminaria')
                        .upload(fileName, imageFile);
                    if (uploadError) throw uploadError;
                    
                    const { data: publicUrlData } = dbClient.storage
                        .from('luminaria')
                        .getPublicUrl(fileName);
                    dataToInsert.image_url = publicUrlData.publicUrl;
                }

                const { error: insertError } = await dbClient.from('inspections').insert([dataToInsert]);
                if (insertError) throw insertError;
                
                showMessage('Éxito', 'El reporte ha sido enviado correctamente.', 'success');
                form.reset();
                imageUploadContainer.classList.add('hidden');

            } catch (error) {
                console.error('Error en el proceso:', error);
                showMessage('Error', error.message, 'error');
            } finally {
                setLoading(false);
            }
        });
        
        // --- CARGAR Y SUSCRIBIRSE A REPORTES (TIEMPO REAL) ---
        function subscribeToReports() {
            dbClient
              .channel('public:inspections')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'inspections' }, payload => {
                console.log('Change received!', payload);
                handleRealtimeChange(payload);
              })
              .subscribe();
            
            // Carga inicial de datos
            loadInitialReports();
        }
        
        async function loadInitialReports() {
            const { data, error } = await dbClient
                .from('inspections')
                .select('id, luminaire_id, notes, latitude, longitude, status');
            if (error) {
                console.error('Error cargando reportes iniciales:', error);
                return;
            }
            data.forEach(report => updateMapWithReport(report));
        }
        
        function handleRealtimeChange(payload) {
            const report = payload.new;
            const reportId = report.id;

            // Si el reporte es nuevo o actualizado y está dañado
            if ((payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') && report.status === 'Dañado') {
                updateMapWithReport(report);
            } 
            // Si el reporte se actualizó a un estado que no es "Dañado", o se eliminó
            else if (reportMarkers[reportId]) {
                map.removeLayer(reportMarkers[reportId]);
                delete reportMarkers[reportId];
            }
        }

        function updateMapWithReport(report) {
            if (report.status !== 'Dañado' || !report.latitude || !report.longitude) {
                // Si el reporte ya no está dañado y existe en el mapa, lo quitamos
                if(reportMarkers[report.id]) {
                    map.removeLayer(reportMarkers[report.id]);
                    delete reportMarkers[report.id];
                }
                return;
            }

            const reportCoords = [report.latitude, report.longitude];
            const popupContent = `<b>ID: ${report.luminaire_id}</b><br>${report.notes || 'Sin notas.'}`;
            
            // Si el marcador ya existe, solo actualizamos su popup
            if (reportMarkers[report.id]) {
                reportMarkers[report.id].setLatLng(reportCoords).setPopupContent(popupContent);
            } else {
                // Si es nuevo, lo creamos
                const reportIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                });
                
                const newMarker = L.marker(reportCoords, { icon: reportIcon })
                    .addTo(map)
                    .bindPopup(popupContent);
                
                reportMarkers[report.id] = newMarker;
            }
        }

        // --- FUNCIONES AUXILIARES ---
        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            buttonText.classList.toggle('hidden', isLoading);
            loader.classList.toggle('hidden', !isLoading);
        }
        
        function showMessage(title, message, type = 'info') {
            const modal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalIcon = document.getElementById('modalIcon');
            const closeModalButton = document.getElementById('closeModalButton');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalIcon.innerHTML = '';
            modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full'; // Reset classes
            
            const icons = {
                success: {
                    svg: `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`,
                    bg: 'bg-green-100'
                },
                error: {
                    svg: `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`,
                    bg: 'bg-red-100'
                },
                warning: {
                    svg: `<svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`,
                    bg: 'bg-yellow-100'
                }
            };

            const selectedIcon = icons[type] || icons.warning;
            modalIcon.classList.add(selectedIcon.bg);
            modalIcon.innerHTML = selectedIcon.svg;
            
            modal.classList.remove('hidden');
            closeModalButton.onclick = () => modal.classList.add('hidden');
        }
    </script>
</body>
</html>
